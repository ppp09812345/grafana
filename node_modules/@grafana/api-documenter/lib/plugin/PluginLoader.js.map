{"version":3,"file":"PluginLoader.js","sourceRoot":"","sources":["../../src/plugin/PluginLoader.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport * as resolve from 'resolve';\r\n\r\nimport { IApiDocumenterPluginManifest, IFeatureDefinition } from './IApiDocumenterPluginManifest';\r\nimport { MarkdownDocumenterFeature, MarkdownDocumenterFeatureContext } from './MarkdownDocumenterFeature';\r\nimport { PluginFeatureInitialization } from './PluginFeature';\r\nimport { DocumenterConfig } from '../documenters/DocumenterConfig';\r\n\r\ninterface ILoadedPlugin {\r\n  packageName: string;\r\n  manifest: IApiDocumenterPluginManifest;\r\n}\r\n\r\nexport class PluginLoader {\r\n  public markdownDocumenterFeature: MarkdownDocumenterFeature | undefined;\r\n\r\n  public load(documenterConfig: DocumenterConfig, createContext: () => MarkdownDocumenterFeatureContext): void {\r\n    const configFileFolder: string = path.dirname(documenterConfig.configFilePath);\r\n    for (const configPlugin of (documenterConfig.configFile.plugins || [])) {\r\n      try {\r\n        // Look for the package name in the same place as the config file\r\n        const resolvedEntryPointPath: string = resolve.sync(configPlugin.packageName, {\r\n          basedir: configFileFolder\r\n        });\r\n\r\n        // Load the package\r\n        // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n        const entryPoint: object | undefined = require(resolvedEntryPointPath);\r\n\r\n        if (!entryPoint) {\r\n          throw new Error('Invalid entry point');\r\n        }\r\n\r\n        const manifest: IApiDocumenterPluginManifest\r\n          // eslint-disable-next-line dot-notation\r\n          = entryPoint['apiDocumenterPluginManifest'] as IApiDocumenterPluginManifest;\r\n\r\n        if (!manifest) {\r\n          throw new Error(`The package is not an API documenter plugin;`\r\n            + ` the \"apiDocumenterPluginManifest\" export was not found`);\r\n        }\r\n\r\n        if (manifest.manifestVersion !== 1000) {\r\n          throw new Error(`The plugin is not compatible with this version of API Documenter;`\r\n            + ` unsupported manifestVersion`);\r\n        }\r\n\r\n        const loadedPlugin: ILoadedPlugin = {\r\n          packageName: configPlugin.packageName,\r\n          manifest\r\n        };\r\n\r\n        const featureDefinitionsByName: Map<string, IFeatureDefinition> = new Map<string, IFeatureDefinition>();\r\n        for (const featureDefinition of manifest.features) {\r\n          featureDefinitionsByName.set(featureDefinition.featureName, featureDefinition);\r\n        }\r\n\r\n        for (const featureName of configPlugin.enabledFeatureNames) {\r\n          const featureDefinition: IFeatureDefinition | undefined = featureDefinitionsByName.get(featureName);\r\n          if (!featureDefinition) {\r\n            throw new Error(`The plugin ${loadedPlugin.packageName} does not have`\r\n              + ` a feature with name \"${featureName}\"`);\r\n          }\r\n\r\n          if (featureDefinition.kind === 'MarkdownDocumenterFeature') {\r\n            if (this.markdownDocumenterFeature) {\r\n              throw new Error('A MarkdownDocumenterFeature is already loaded');\r\n            }\r\n\r\n            const initialization: PluginFeatureInitialization  = new PluginFeatureInitialization();\r\n            initialization._context = createContext();\r\n\r\n            let markdownDocumenterFeature: MarkdownDocumenterFeature | undefined = undefined;\r\n            try {\r\n              markdownDocumenterFeature = new featureDefinition.subclass(initialization);\r\n            } catch (e) {\r\n              throw new Error(`Failed to construct feature subclass:\\n` + e.toString());\r\n            }\r\n            if (!(markdownDocumenterFeature instanceof MarkdownDocumenterFeature)) {\r\n              throw new Error('The constructed subclass was not an instance of MarkdownDocumenterFeature');\r\n            }\r\n\r\n            try {\r\n              markdownDocumenterFeature.onInitialized();\r\n            } catch (e) {\r\n              throw new Error('Error occurred during the onInitialized() event: ' + e.toString());\r\n            }\r\n\r\n            this.markdownDocumenterFeature = markdownDocumenterFeature;\r\n          } else {\r\n            throw new Error(`Unknown feature definition kind: \"${featureDefinition.kind}\"`);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        throw new Error(`Error loading plugin ${configPlugin.packageName}: ` + e.message);\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n"]}